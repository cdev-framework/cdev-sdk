from pydantic.main import BaseModel
from enum import Enum
from typing import List, Optional, Dict, Union, Dict

from ...models import Cloud_Output, Rendered_Resource

from ...backend import cloud_mapper_manager

{% macro render_flatstruct(struct) -%}
class {{struct.get("name")}}(BaseModel):
    {%if struct.get('documentation')%}
    """
    {{markdownify(struct.get('documentation').strip())}}
    """
    {%endif%}


{% for attribute_name, val in struct.get("attributes").items() %}
    {% if val.get("type") == "string"%}
    {{pythonify_symbol(attribute_name)}}: Union[str, Cloud_Output]
    {% elif val.get("type") == "boolean"%}
    {{pythonify_symbol(attribute_name)}}: Union[bool, Cloud_Output]
    {% elif val.get("type") == "list"%}
    {{pythonify_symbol(attribute_name)}}: Union[List[{{val.get("val_type")}}], Cloud_Output]
    {% elif val.get("type") == "enum"%}
    {{pythonify_symbol(attribute_name)}}: Union[{{val.get("name")}}, Cloud_Output]
    {% elif val.get("type") == "structure"%}
    {{pythonify_symbol(attribute_name)}}: Union[{{val.get("name")}}, Cloud_Output] 
    {% elif val.get("type") == "long"%}
    {{pythonify_symbol(attribute_name)}}: Union[int, Cloud_Output]
    {% elif val.get("type") == "integer"%}
    {{pythonify_symbol(attribute_name)}}: Union[int, Cloud_Output]
    {% elif val.get("type") == "double"%}
    {{pythonify_symbol(attribute_name)}}: Union[int, Cloud_Output]
    {% elif val.get("type") == "map"%}
    {{pythonify_symbol(attribute_name)}}: Dict[{{val.get("key_type")}}, {{val.get("key_type")}}]
    {% elif val.get("type") == "blob"%}
    {{pythonify_symbol(attribute_name)}}: Union[bytes, Cloud_Output]
    {%else%}
    {{pythonify_symbol(attribute_name)}}; {{val}}
    Bad
    {% endif %}
    {% if val.get('documentation')%}
    """
    {{markdownify(val.get('documentation').strip())}}
    """
    {% endif %}

{% endfor %}

    def __init__(self, {{flatten_structure_to_params(struct.get("attributes"))}} ):
        "My doc string"
        super().__init__(**{
            {%for attribute_name in struct.get("attributes") %}
            "{{pythonify_symbol(attribute_name)}}": {{pythonify_symbol(attribute_name)}},
            {%endfor%}
        })        


{% endmacro -%}

{% for item in var %}
{% if var.get(item).get("type") == "string" %}
{% if "enum" in var.get(item)%}
class {{item}}(str, Enum): 
    {%if var.get(item).get('documentation')%}
    """
    {{markdownify(var.get(item).get('documentation').strip())}}
    """
    {%endif%}


    {% for enum_val in var.get(item).get("enum") %}
    {{pythonify_symbol(enum_val)}} = '{{enum_val}}'
    
    {% endfor %}
    {% endif %}

{% else %}
    {% if var.get(item).get("type") == "structure" -%}
{{render_flatstruct(flatten_structure(item,var.get(item),  var))}}
    {% endif -%}
{% endif %}
{% endfor %}

{% for output in output_models%}
class {{output.get("name")}}(str, Enum):
    {%if output.get('documentation')%}
    """
    {{markdownify(output.get('documentation').strip())}}
    """
    {%endif%}

    {% for attribute in output.get("attributes")%}
    {{attribute.get('label')}} = "{{attribute.get('label')}}"
    {% if attribute.get('documentation')%}
    """
    {{markdownify(attribute.get('documentation').strip())}}
    """
    {% endif %}

    {% endfor %}


{% endfor %}
{% for resource in resources %}
class {{resource.get("resource_name").lower()}}_model(Rendered_Resource):
    {%if resource.get('documentation')%}
    """

    {{markdownify(resource.get('documentation')).strip()}}
    
    """
    {%endif%}


    {% for attribute in resource.get("attributes")%}
    {% if attribute.get("type") == "string"%}
    {{pythonify_symbol(attribute.get("param_name"))}}: {{"Optional[" if not attribute.get("isrequired") else ""}}Union[str, Cloud_Output]{{"]" if not attribute.get("isrequired") else ""}}
    {% elif attribute.get("type") == "boolean"%}
    {{pythonify_symbol(attribute.get("param_name"))}}: {{"Optional[" if not attribute.get("isrequired") else ""}}Union[bool, Cloud_Output]{{"]" if not attribute.get("isrequired") else ""}}
    {% elif attribute.get("type") == "list"%}
    {{pythonify_symbol(attribute.get("param_name"))}}: {{"Optional[" if not attribute.get("isrequired") else ""}}Union[List[{{attribute.get("val_type")}}], Cloud_Output]{{"]" if not attribute.get("isrequired") else ""}}
    {% elif attribute.get("type") == "enum"%}
    {{pythonify_symbol(attribute.get("param_name"))}}: {{"Optional[" if not attribute.get("isrequired") else ""}}Union[{{attribute.get("name")}}, Cloud_Output]{{"]" if not attribute.get("isrequired") else ""}} 
    {% elif attribute.get("type") == "structure"%}
    {{pythonify_symbol(attribute.get("param_name"))}}: {{"Optional[" if not attribute.get("isrequired") else ""}}Union[{{attribute.get("name")}}, Cloud_Output]{{"]" if not attribute.get("isrequired") else ""}} 
    {% elif attribute.get("type") == "long"%}
    {{pythonify_symbol(attribute.get("param_name"))}}: {{"Optional[" if not attribute.get("isrequired") else ""}}Union[int, Cloud_Output]{{"]" if not attribute.get("isrequired") else ""}}
    {% elif attribute.get("type") == "integer"%}
    {{pythonify_symbol(attribute.get("param_name"))}}: {{"Optional[" if not attribute.get("isrequired") else ""}}Union[int, Cloud_Output]{{"]" if not attribute.get("isrequired") else ""}}
    {% elif attribute.get("type") == "map"%}
    {{pythonify_symbol(attribute.get("param_name"))}}: {{"Optional[" if not attribute.get("isrequired") else ""}}Union[Dict[{{attribute.get('key_type')}},{{attribute.get('val_type')}}], Cloud_Output]{{"]" if not attribute.get("isrequired") else ""}}
    {%else%}
    {{pythonify_symbol(attribute.get("param_name"))}}; {{attribute}}
    Bad
    {% endif %}
    {% if attribute.get('documentation')%}
    """
    {{markdownify(attribute.get('documentation')).strip()}}
    """
    {% endif %}


    {% endfor %}

    def filter_to_create(self, identifier) -> dict:
        NEEDED_ATTRIBUTES = set({{resource.get("as_list")}})

        return {k:v for k,v in self.dict().items() if k in NEEDED_ATTRIBUTES and v}

    def filter_to_remove(self, identifier) -> dict:
        NEEDED_ATTRIBUTES = set({{resource.get("remove_attributes")}})
        return {(k if type(k)==str else k[0]):(cloud_mapper_manager.get_output_value(identifier, k) if type(k)==str else cloud_mapper_manager.get_output_value(identifier, k[1])) for k in NEEDED_ATTRIBUTES }

    class Config:
        extra='ignore'


{% endfor %}